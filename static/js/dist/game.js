let COLORS=["pink","blue","purple","orange","grey"];class Funcions{constructor(){}static sleep(t){return new Promise((s=>setTimeout(s,t)))}static make_color(){return COLORS[Math.floor(5*Math.random())]}}class Settings{constructor(t){this.root=t,this.platform="WEB",this.root.AcWingOS&&(this.platform="ACAPP"),this.$settings=$('\n        <div class = "game_settings">\n            <div class = "game_settings-login">\n                <div class = "game_settings-title">\n                    登 录\n                </div>\n\n                <div class = "game_settings-username">\n                    <div class = "game_settings-item">\n                        <input type = "text" placeholder = "用户名">\n                    </div>\n                </div>\n\n                <div class = "game_settings-password">\n                    <div class = "game_settings-item">\n                        <input type = "password" placeholder = "密码">\n                    </div>\n                </div>\n\n                <div class = "game_settings-submit">\n                    <div class = "game_settings-item">\n                        <button>登 录</button>\n                    </div>\n                </div>\n\n                <div class = "game_settings-erro-messages">\n                </div>\n\n                <div class = "game_settings-option">\n                    注册\n                </div>\n                <br>\n                <div class = "game_settings-acwing">\n                    <img width = "40" \n                        src = "https://app1179.acapp.acwing.com.cn/static/image/settings/acwing_logo.png"\n                    >\n                </div>\n            </div>\n\n            <div class = "game_settings-register">\n                <div class = "game_settings-title">\n                    注册\n                </div>\n\n                <div class = "game_settings-username">\n                    <div class = "game_settings-item">\n                    <input type = "text" placeholder = "用户名">\n                    </div>\n                </div>\n\n                <div class = "game_settings-password password_first">\n                    <div class = "game_settings-item">\n                        <input type = "password" placeholder = "密码">\n                    </div>\n                </div>\n                \n                <div class = "game_settings-password password_second">\n                    <div class = "game_settings-item">\n                        <input type = "password" placeholder = "确认密码">\n                    </div>\n                </div>\n\n                <div class = "game_settings-submit">\n                    <div class = "game_settings-item">\n                        <button>注 册</button>\n                    </div>\n                </div>\n\n                <div class = "game_settings-erro-messages">\n                </div>\n\n                <div class = "game_settings-option">\n                    登录\n                </div>\n            </div>    \n        </div>\n        '),this.$login=this.$settings.find(".game_settings-login"),this.$login.hide(),this.$login_username=this.$login.find(".game_settings-username input"),this.$login_password=this.$login.find(".game_settings-password input"),this.$login_submit=this.$login.find(".game_settings-submit button"),this.$login_erro=this.$login.find(".game_settings-erro-messages"),this.$login_register=this.$login.find(".game_settings-option"),this.$login_acwing=this.$login.find(".game_settings-acwing img"),this.$register=this.$settings.find(".game_settings-register"),this.$register.hide(),this.$register_username=this.$register.find(".game_settings-username input"),this.$register_password=this.$register.find(".password_first input"),this.$register_password_again=this.$register.find(".password_second input"),this.$register_submit=this.$register.find(".game_settings-submit button"),this.$register_erro=this.$register.find(".game_settings-erro-messages"),this.$register_login=this.$register.find(".game_settings-option"),this.root.$game.append(this.$settings),this.start()}start(){"ACAPP"===this.platform?(console.log("in acapp"),this.getinfo_acapp()):(this.getinfo_web(),this.add_listening_events())}add_listening_events(){this.add_login_listening_events(),this.add_register_listening_events()}add_login_listening_events(){let t=this;this.$login_register.click((function(){t.register()})),this.$login_submit.click((function(){t.login_remote()})),this.$login_acwing.click((function(){t.login_acwing_in_web()}))}add_register_listening_events(){let t=this;this.$register_login.click((function(){t.login()})),this.$register_submit.click((function(){t.register_remote()}))}login_remote(){let t=this,s=this.$login_username.val(),i=this.$login_password.val();this.$login_erro.empty(),$.ajax({url:"https://app1179.acapp.acwing.com.cn/settings/signin/",type:"GET",data:{username:s,password:i},success:function(s){"success"===s.result?location.reload():t.$login_erro.html(s.result)}})}login_acwing_in_web(){$.ajax({url:"https://app1179.acapp.acwing.com.cn/settings/acwing/web/apply_code/",type:"GET",success:function(t){console.log(t),"success"===t.result?window.location.replace(t.apply_code_url):console.log("erro")}})}login_acwing_in_acapp(t,s,i,e){let a=this;this.root.AcWingOS.api.oauth2.authorize(t,s,i,e,(function(t){"success"===t.result?(console.log(t),a.username=t.username,a.photo=t.photo,a.hide(),a.root.menu.show()):console.log("登录失败")}))}logout_remote(){"ACAPP"===this.platform?this.root.AcWingOS.api.window.close():$.ajax({url:"https://app1179.acapp.acwing.com.cn/settings/signout/",type:"GET",success:function(t){"success"===t.result&&location.reload()}})}register_remote(){let t=this,s=this.$register_username.val(),i=this.$register_password.val(),e=this.$register_password_again.val();this.$register_erro.empty(),$.ajax({url:"https://app1179.acapp.acwing.com.cn/settings/register/",type:"GET",data:{username:s,password:i,password_again:e},success:function(s){"success"===s.result?location.reload():t.$register_erro.html(s.result)}})}login(){this.$register.hide(),this.$login.show()}register(){this.$login.hide(),this.$register.show()}getinfo_acapp(){let t=this;$.ajax({url:"https://app1179.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/",type:"GET",success:function(s){"success"===s.result?t.login_acwing_in_acapp(s.app_id,s.redirect_uri,s.scope,s.state):console.log("fail to getinfo from acapp")}})}getinfo_web(){let t=this;$.ajax({url:"https://app1179.acapp.acwing.com.cn/settings/getinfo/",type:"GET",data:{platform:t.platform},success:function(s){"success"===s.result?(t.username=s.username,t.photo=s.photo,t.hide(),t.root.menu.show()):t.login()}})}hide(){this.$settings.hide()}show(){this.$settings.show()}}class GameMenu{constructor(t){this.root=t,this.$menu=$('\n        <div class="game_menu" id = "menu">\n            <div class="game_menu-field" id = "menu-field">\n                <div class="game_menu-field-item game_menu-field-item-single-mode" id = "single-mode">\n                    单人模式\n                </div>\n                <br>\n                <div class="game_menu-field-item game_menu-field-item-multi-mode" id = "multi-mode">\n                    多人模式\n                </div>\n                <br>\n                <div class="game_menu-field-item game_menu-field-item-settings" id = "settings">\n                    退出\n                </div>\n            </div>\n            <div class="game_menu-field" id = "difficulty-menu">\n                <div class="game_menu-field-item game_menu-field-item-easy" id = "easy">\n                    简易模式\n                </div>\n                <br>\n                <div class="game_menu-field-item game_menu-field-item-normal" id = "normal">\n                    一般模式\n                </div>\n                <br>\n                <div class="game_menu-field-item game_menu-field-item-hard" id = "hard">\n                    困难模式\n                </div>\n                <br>\n                <div class="game_menu-field-item game_menu-field-item-back" id = "back">\n                    返回\n                </div>\n            </div>\n        </div>\n        '),this.$menu.hide(),this.root.$game.append(this.$menu),this.$single_mode=this.$menu.find(".game_menu-field-item-single-mode"),this.$multi_mode=this.$menu.find(".game_menu-field-item-multi-mode"),this.$settings=this.$menu.find(".game_menu-field-item-settings"),this.$easy=this.$menu.find(".game_menu-field-item-easy"),this.$normal=this.$menu.find(".game_menu-field-item-normal"),this.$hard=this.$menu.find(".game_menu-field-item-hard"),this.$back=this.$menu.find(".game_menu-field-item-back"),this.menus=document.getElementById("menu"),this.menu_field=document.getElementById("menu-field"),this.difficulty_menu=document.getElementById("difficulty-menu"),this.childs=this.menus.childNodes,this.start()}show_all_childsNode(){console.log("");for(let t=0;t<this.childs.length;t++)console.log(this.childs[t])}match_node(t){for(let s=0;s<this.childs.length;s++)if(this.childs[s].isEqualNode(t))return!0;return!1}start(){this.hide_second_menu(),this.add_listening_events()}hide_first_menu(){this.match_node(this.menu_field)&&this.menus.removeChild(this.menu_field)}hide_second_menu(){this.match_node(this.difficulty_menu)&&this.menus.removeChild(this.difficulty_menu)}show_first_menu(){this.match_node(this.menu_field)||this.menus.appendChild(this.menu_field)}show_second_menu(){this.match_node(this.difficulty_menu)||this.menus.appendChild(this.difficulty_menu)}add_listening_events(){let t=this;this.$single_mode.click((function(){t.hide_first_menu(),t.show_second_menu()})),this.$multi_mode.click((function(){t.hide(),t.root.playground.show(1,MULTI_MODE),console.log("click multi mode")})),this.$settings.click((function(){t.root.settings.logout_remote()})),this.$easy.click((function(){t.hide(),t.root.playground.show(1,SINGLE_MODE)})),this.$normal.click((function(){t.hide(),t.root.playground.show(2,SINGLE_MODE)})),this.$hard.click((function(){t.hide(),t.root.playground.show(3,SINGLE_MODE)})),this.$back.click((function(){t.hide_second_menu(),t.show_first_menu()}))}show(){this.$menu.show()}hide(){this.$menu.hide()}}let last_time_stamp,GAME_OBJECTS=[];class GameObject{constructor(){GAME_OBJECTS.push(this),this.called_start=!1,this.time_delta=0,this.uuid=this.create_uuid()}create_uuid(){let t="";for(let s=0;s<8;s++){t+=parseInt(Math.floor(10*Math.random()))}return t}start(){return!this.called_start}update(){}finalize(){}destroy(){this.finalize();for(let t=0;t<GAME_OBJECTS.length;t++)if(this===GAME_OBJECTS[t]){GAME_OBJECTS.splice(t,1);break}}}let GAME_ANIMATION=function(t){for(let s=0;s<GAME_OBJECTS.length;s++){let i=GAME_OBJECTS[s];i.called_start?(i.time_delta=t-last_time_stamp,i.update()):(i.start(),i.called_start=!0)}last_time_stamp=t,requestAnimationFrame(GAME_ANIMATION)};requestAnimationFrame(GAME_ANIMATION);class MovableGameObject extends GameObject{constructor(t,s,i,e,a,h){super(),this.x=t,this.y=s,this.vx=i,this.vy=e,this.speed=a,this.moveLength=h}move_to(t,s){let i=t-this.x,e=s-this.y;this.moveLength=Math.sqrt(i*i+e*e),this.vx=i/this.moveLength,this.vy=e/this.moveLength}update(){this.update_position()}update_position(){let t=Math.min(this.moveLength,this.speed*this.time_delta*.001),s=this.vx*t,i=this.vy*t;this.x+=s,this.y+=i,this.moveLength-=t}}class UnmovableGameObject extends GameObject{constructor(t,s){super(),this.x=t,this.y=s}update(){}}class BloodPacks extends MovableGameObject{constructor(t,s,i,e,a,h,r,n,o){super(s,i,e,a,h,r),this.playground=t,this.ctx=t.game_map.ctx,this.img=new Image,this.img.src="https://gss0.baidu.com/-vo3dSag_xI4khGko9WTAnF6hhy/zhidao/wh%3D600%2C800/sign=da7a4646184c510fae91ea1c50690915/b21bb051f81986186b44770a48ed2e738bd4e639.jpg",this.radius=n,this.owner=null,this.idx=o,this.friction=.985}start(){}finalize(){let t=this.playground.game_map.rewards.length;for(let s=this.idx+1;s<t;s++)this.playground.game_map.rewards[s].idx--;this.playground.game_map.rewards.splice(this.idx,1)}work(){this.owner.HP++}check(){let t,s;this.owner.charactor==ME?(t=this.owner.x-this.x+this.playground.offset_x,s=this.owner.y-this.y+this.playground.offset_y):(t=this.owner.x-this.x,s=this.owner.y-this.y),Math.sqrt(t*t+s*s)<this.radius+this.owner.radius&&(this.work(),this.destroy())}check_stop(){return this.moveLength<.01&&(this.moveLength=0,this.speed=BLOOD_PACKS_SPEED,this.vx=this.vy=0,!0)}update(){this.owner?(this.check(),this.owner.charactor==ME?this.move_to(this.owner.x+this.playground.offset_x,this.owner.y+this.playground.offset_y):this.move_to(this.owner.x,this.owner.y)):this.speed*=this.friction,this.check_stop()||this.update_position(),this.render()}render(){let t,s,i=this.playground.scale,e=this.radius*i;t=(this.x-this.playground.offset_x)*i,s=(this.y-this.playground.offset_y)*i,this.playground.check_in_camare(t,s,e)&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,s,e,0,2*Math.PI,!1),this.ctx.strokeStyle="orange",this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,t-e,s-e,2*e,2*e),this.ctx.restore())}}class Boom extends UnmovableGameObject{constructor(t,s,i,e,a){super(s,i),this.playground=t,this.ctx=t.game_map.ctx,this.idx=a,this.img=new Image,this.img.src="https://pic34.photophoto.cn/20150301/0014026901644584_b.jpg",this.radius=e,this.largen_speed=1.01,this.damage_range=5*e,this.final_radius=3*this.radius,this.damage=5,this.awake=!1}start(){}finalize(){let t=this.playground.game_map.booms.length;for(let s=this.idx+1;s<t;s++)this.playground.game_map.booms[s].idx--;this.playground.game_map.booms.splice(this.idx,1)}check_damage(t){let s,i;t.charactor==ME?(s=this.x-this.playground.offset_x-t.x,i=this.y-this.playground.offset_y-t.y):(s=this.x-t.x,i=this.y-t.y);let e=Math.sqrt(s*s+i*i);e<this.damage_range+t.radius&&this.damage_work(t,s/e,i/e)}damage_work(t,s,i){t.be_hit(this.damage),t.vx=8*-s,t.vy=8*-i,t.moveLength=.25}work(){let t=this.playground.players.length;for(let s=0;s<t;s++){let t=this.playground.players[s];this.check_damage(t)}}update(){this.awake&&(this.radius*=this.largen_speed,this.damage_range*=this.largen_speed,this.radius>=this.final_radius&&(this.work(),this.destroy())),this.render()}render(){let t,s,i=this.playground.scale,e=this.radius*i;t=(this.x-this.playground.offset_x)*i,s=(this.y-this.playground.offset_y)*i,this.playground.check_in_camare(t,s,e)&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,s,e,0,2*Math.PI,!1),this.ctx.strokeStyle="red",this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,t-e,s-e,2*e,2*e),this.ctx.restore(),this.awake&&(this.ctx.beginPath(),this.ctx.arc(t,s,this.damage_range*i,0,2*Math.PI,!1),this.ctx.strokeStyle="red",this.ctx.stroke()))}}class Line extends GameObject{constructor(t,s,i,e,a,h){super(),this.playground=t,this.ctx=s,this.x1=i,this.y1=e,this.x2=a,this.y2=h,this.eps=.01}update(){this.render()}check_in_camare(t,s){return t>=0&&t<=this.playground.camare_width||s>=0&&s<=this.playground.camare_height}render(){let t,s,i,e,a=this.playground.scale;t=(this.x1-this.playground.offset_x)*a,i=(this.x2-this.playground.offset_x)*a,s=(this.y1-this.playground.offset_y)*a,e=(this.y2-this.playground.offset_y)*a,this.check_in_camare(t,s)&&(this.ctx.beginPath(),this.ctx.moveTo(t,s),this.ctx.lineTo(i,e),this.ctx.strokeStyle="rgba(204, 200, 200, 0.095)",this.ctx.stroke())}}class GameMap extends GameObject{constructor(t){super(),this.playground=t,this.$canvas=$("<canvas></canvas>"),this.ctx=this.$canvas[0].getContext("2d"),this.ctx.canvas.width=this.playground.camare_width,this.ctx.canvas.height=this.playground.camare_height,this.playground.$playground.append(this.$canvas),this.lines=[],this.verticals=[],this.rewards=[],this.booms=[],this.canvas_config="big_map"===this.playground.map_mode?1:.2,this.init_line(this.ctx)}start(){this.init_blood_packs(),this.init_booms()}init_line(t){let s=this.ctx.canvas.width/7/this.playground.scale,i=2.5*this.ctx.canvas.width/this.playground.scale,e=2.5,a=4*this.ctx.canvas.width/this.playground.scale;for(let h=0;h<29;h++)this.verticals.push(new Line(this.playground,t,i,e-a+3,i,e)),i-=s;i=2.5*this.ctx.canvas.width/this.playground.scale;for(let h=0;h<17;h++)this.lines.push(new Line(this.playground,t,i-a,e,i,e)),e-=s}init_booms(){for(let t=0;t<10;t++){let s=(4*Math.random()-1.5)*this.playground.camare_width/this.playground.scale,i=4*Math.random()-1.5;this.booms.push(new Boom(this.playground,s,i,.03,t))}}init_blood_packs(){for(let t=0;t<10;t++){let s=(4*Math.random()-1.5)*this.playground.camare_width/this.playground.scale,i=4*Math.random()-1.5;this.rewards.push(new BloodPacks(this.playground,s,i,0,0,BLOOD_PACKS_SPEED,0,.025,t))}}resize(){this.ctx.canvas.width=this.playground.camare_width,this.ctx.canvas.height=this.playground.camare_height,this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}update(){this.render()}render(){this.ctx.fillStyle="rgba(0, 0, 0, 0.55)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}}class NoticeBoard extends UnmovableGameObject{constructor(t,s,i){super(s,i),this.playground=t,this.ctx=this.playground.game_map.ctx,this.text="存活：",this.size=.036,this.count_down=0}start(){}update_text(t){this.text=t}update(){this.count_down++>60&&(this.count_down=0,this.update_text("存活："+this.playground.players.length+" 人")),this.render()}render(){let t=this.size*this.playground.scale;this.ctx.font=t+"px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(this.text,this.x*this.playground.scale,this.y*this.playground.scale)}}class Particle extends MovableGameObject{constructor(t,s,i,e,a,h,r,n,o,l){super(s,i,r,n,h,o),this.playground=t,this.ctx=this.playground.game_map.ctx,this.radius=e,this.color=a,this.eps=.01,this.friction=.94,this.charactor=l}start(){}static make_particle(t,s,i,e){let a=t.radius*s*.35*i;t.HP<=0&&(a*=15/i);for(let s=0;s<a;s++){let s=2*Math.PI*Math.random(),i=Math.cos(s),a=Math.sin(s);new Particle(t.playground,t.x,t.y,t.radius*s*.02,t.color,PARTICLE_SPEED*Math.random(),i,a,s*Math.random()*.38,e)}}check_state(){return!(this.speed<this.eps||this.moveLength<this.eps)}update(){this.check_state()||this.destroy(),this.speed*=this.friction,this.update_position(),this.render()}render(){let t,s,i=this.playground.scale,e=this.radius*i;this.charactor==ME?(t=this.x*i,s=this.y*i):(t=(this.x-this.playground.offset_x)*i,s=(this.y-this.playground.offset_y)*i),(1==this.charactor||this.playground.check_in_camare(t,s,e))&&(this.ctx.beginPath(),this.ctx.arc(t,s,e,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}}class Player extends MovableGameObject{constructor(t,s,i,e,a,h,r,n,o,l=""){if(super(i,e,0,0,r,0),this.playground=t,this.HP=s,this.ctx=this.playground.game_map.ctx,this.radius=a,this.color=h,this.charactor=n,this.eps=.01,this.shield=!1,this.shield_size=3*this.radius,this.is_bursting=!1,this.cur_skill=0,this.be_hitted=!1,this.friction=.93,this.charactor==ME&&(this.mouse_x=0,this.mouse_y=0,this.cd=new CD(t)),this.fire_balls=[],this.username=o,this.charactor!=ROBOT)this.img=new Image,this.img.src=l;else switch(this.playground.difficulty){case 1:this.probability=1e3;break;case 2:this.probability=550;break;case 3:this.probability=420}}start(){this.charactor==ME?this.add_listening_event():this.charactor==ROBOT&&this.ai_move()}unleash_skills(t,s,i=0,e=0){if(this.cur_skill>=1&&this.cur_skill<=5){let a=t-this.x,h=s-this.y,r=Math.sqrt(a*a+h*h),n=a/r,o=h/r;switch(this.cur_skill){case 1:let t=0==this.fire_balls.length?1:this.fire_balls.length+1;this.fire_balls.push(new FireBall(this,this.fire_balls.length,.015,"red",FIRE_BALL_SPEED*t,n,o,.5,1,i,e,0,0));break;case 2:this.shield=!0;break;case 3:this.is_bursting||new Burst(this.playground,this,n,o)}this.cur_skill=0}}add_listening_event(){let t=this;this.playground.game_map.$canvas.on("contextmenu",(function(){return!1}));let s=this.ctx.canvas.getBoundingClientRect();this.playground.game_map.$canvas.mousedown((function(i){if(s=t.ctx.canvas.getBoundingClientRect(),3===i.which&&t.HP>0&&!t.be_hitted&&!t.is_bursting&&(t.move_to((i.clientX-s.left)/t.playground.scale,(i.clientY-s.top)/t.playground.scale),t.playground.game_mode==MULTI_MODE)){let s=t.x+t.playground.offset_x,i=t.y+t.playground.offset_y;t.playground.mps.send_move_to(t.uuid,s,i,t.vx,t.vy,t.moveLength)}})),this.playground.game_map.$canvas.mousemove((function(i){t.HP>0&&(t.mouse_x=i.clientX-s.left,t.mouse_y=i.clientY-s.top)})),$(window).keydown((function(s){if(t.HP>0&&!t.be_hitted){switch(s.which){case 81:t.cd.unleash_fire_ball_request()&&(t.cur_skill=1,t.playground.game_mode==MULTI_MODE&&t.playground.mps.send_shoot_fire_ball(t.uuid,t.mouse_x/t.playground.scale+t.playground.offset_x,t.mouse_y/t.playground.scale+t.playground.offset_y,t.playground.offset_x,t.playground.offset_y));break;case 87:t.cd.unleash_shield_request()&&(t.cur_skill=2,t.playground.game_mode==MULTI_MODE&&t.playground.mps.send_shield(t.uuid));break;case 69:t.cd.unleash_burst_request()&&(t.cur_skill=3,t.playground.game_mode==MULTI_MODE&&t.playground.mps.send_burst(t.uuid,t.mouse_x/t.playground.scale+t.playground.offset_x,t.mouse_y/t.playground.scale+t.playground.offset_y));break;case 82:t.cur_skill=4;break;case 68:t.cur_skill=5;break;case 70:t.cur_skill=6;break;case 83:t.be_hitted||t.is_bursting||(t.moveLength=0,t.playground.game_mode==MULTI_MODE&&t.playground.mps.send_move_stop(t.uuid))}t.unleash_skills(t.mouse_x/t.playground.scale,t.mouse_y/t.playground.scale,t.playground.offset_x,t.playground.offset_y)}}))}ai_unleash_skills(){if(2==Math.floor(Math.random()*this.probability)){let t=1;switch(1+Math.floor(6*Math.random())){case 1:case 2:case 3:case 4:this.cur_skill=1,t=3==this.difficulty?4:3;break;case 5:this.cur_skill=2;break;case 6:this.cur_skill=3}let s=this.playground.players[this.playground.players.length-1],i=s.x,e=s.y;for(let s=0;s<t;s++)3==t&&(this.cur_skill=1),this.unleash_skills(i,e)}}ai_move(){let t=(4*Math.random()-1.5)*this.playground.camare_width/this.playground.scale,s=4*Math.random()-1.5;this.move_to(t,s)}be_hit(t,s,i){this.be_hitted=!0,this.is_bursting=!1,this.HP-=t,this.vx=2*s*t,this.vy=2*i*t,this.moveLength=.12*t,Particle.make_particle(this,this.playground.scale,t,this.charactor)}update(){let t=Math.min(this.moveLength,this.speed*this.time_delta*.001),s=this.vx*t,i=this.vy*t;this.charactor==ME&&(this.playground.update_offset(s,i,this.radius),this.update_fireBalls_offset(s,i),this.cd.update_cd()),this.update_position(s,i,t),this.render()}update_fireBalls_offset(t,s){for(let i=0;i<this.fire_balls.length;i++)this.fire_balls[i].offset_owner_x+=t,this.fire_balls[i].offset_owner_y+=s}update_position(t,s,i){this.moveLength<this.eps?(this.moveLength=0,this.be_hitted=!1,this.is_bursting=!1,this.charactor!=ROBOT?this.vx=this.vy=0:this.ai_move()):((this.be_hitted||this.is_bursting)&&(this.vx*=this.friction,this.vy*=this.friction),this.charactor==ROBOT&&this.ai_unleash_skills(),this.charactor!=ME&&(this.x+=t,this.y+=s),this.moveLength-=i)}render(){let t,s,i=this.playground.scale,e=this.radius*i;this.charactor==ME?(t=this.x*i,s=this.y*i):(t=(this.x-this.playground.offset_x)*i,s=(this.y-this.playground.offset_y)*i),(this.charactor==ME||this.playground.check_in_camare(t,s,e))&&(this.shield&&(this.ctx.beginPath(),this.ctx.arc(t,s,this.shield_size*i,2*Math.PI,!1),this.ctx.strokeStyle=this.color,this.ctx.stroke()),this.ctx.beginPath(),this.ctx.arc(t,s,.007*i+e,0,2*Math.PI*this.HP*.05,!1),this.ctx.fillStyle="red",this.ctx.fill(),2!=this.charactor?(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,s,e,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,t-e,s-e,2*e,2*e),this.ctx.restore()):(this.ctx.beginPath(),this.ctx.arc(t,s,e,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()))}finalize(){let t=this.playground.game_map.rewards.length,s=2*Math.PI*Math.random(),i=Math.cos(s),e=Math.sin(s);this.playground.game_map.rewards.push(new BloodPacks(this.playground,this.x,this.y,i,e,BLOOD_PACKS_SPEED/2,GENERATE_REWARDS_MOVELENGTH,.025,t))}}class Burst extends GameObject{constructor(t,s,i,e){super(),this.playground=t,this.me=s,this.vx=i,this.vy=e,this.damage=2}start(){this.me.is_bursting=!0,this.me.vx=9*this.vx,this.me.vy=9*this.vy,this.me.moveLength=.1}hit_check(){for(let t=0;t<this.playground.players.length;t++){let s=this.playground.players[t];if(s.uuid!==this.me.uuid){let i,e;1==this.me.charactor&&1!=s.charactor?(i=this.me.x-s.x+this.playground.offset_x,e=this.me.y-s.y+this.playground.offset_y):1!=this.me.charactor&&(1!=s.charactor?(i=this.me.x-s.x,e=this.me.y-s.y):1==s.charactor&&(i=this.me.x-this.playground.offset_x-s.x,e=this.me.y-this.playground.offset_y-s.y));let a=Math.sqrt(i*i+e*e);a<this.me.radius+s.radius?(this.damage_work(s,t),this.destroy()):s.shield&&a<this.me.radius+s.shield_size&&(s.shield=!1,this.me.vx=this.me.vy=this.me.moveLength=0,this.destroy())}}}damage_work(t,s){t.is_bursting&&(this.me.be_hit(this.damage,.5*-this.me.vx,.5*-this.me.vy),this.playground.game_mode==MULTI_MODE&&this.playground.mps.send_hit_player(this.me.uuid,this.damage,.5*-this.me.vx,.5*-this.me.vy),this.me.HP<=0&&(this.me.destroy(),this.playground.players.splice(0,1))),t.be_hit(this.damage,.625*this.me.vx,.625*this.me.vy),this.playground.game_mode==MULTI_MODE&&this.playground.mps.send_hit_player(t.uuid,this.damage,.625*this.me.vx,.625*this.me.vy),t.HP<=0&&(this.me.charactor==ME&&this.me.cd.readyed_burst_num++,t.destroy(),this.playground.players.splice(s,1))}update(){this.hit_check(),this.me.moveLength<.01&&this.destroy()}finalize(){this.me.is_bursting=!1,this.me.vx=this.vx,this.me.vy=this.vy}}const CDS=[75,300,180],MAX_NUM=[7,1,1];class CD{constructor(t){this.playground=t,this.ctx=t.game_map.ctx,this.count=0,this.readyed_num=[5,1,1],this.accumulations=[0,0,0],this.imgs=[],this.picture_radius=.033,this.position=[.78,.88,.98],this.init_img()}init_img(){for(let t=0;t<3;t++)this.imgs.push(new Image);this.imgs[0].src="https://bpic.588ku.com/element_origin_min_pic/19/03/07/95a5fd8118dbf18d1521d9bbd1f72662.jpg",this.imgs[1].src="https://img.ixintu.com/download/jpg/201912/3450fb5dea895bda9ee643e32e867a14.jpg!ys",this.imgs[2].src="https://game.gtimg.cn/images/lol/act/img/spell/UFSlash.png"}unleash_fire_ball_request(){return--this.readyed_num[0]>=0||(this.readyed_num[0]=0,!1)}unleash_shield_request(){return--this.readyed_num[1]>=0||(this.readyed_num[1]=0,!1)}unleash_burst_request(){return--this.readyed_num[2]>=0||(this.readyed_num[2]=0,!1)}add_accumulation(){for(let t=0;t<3;t++)this.accumulations[t]=this.readyed_num[t]<MAX_NUM[t]?this.accumulations[t]+6:0,this.accumulations[t]>=CDS[t]&&(this.readyed_num[t]++,this.accumulations[t]=0)}update_cd(){this.count++>5&&(this.count=0,this.add_accumulation()),this.render()}render(){let t=this.playground.scale,s=this.picture_radius*t,i=.85*this.playground.scale;for(let t=0;t<3;t++){let e=this.position[t]*this.playground.scale;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e,i,s,0,2*Math.PI,!1),this.ctx.strokeStyle="orange",this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.imgs[t],e-s,i-s,2*s,2*s),this.ctx.restore(),this.readyed_num[t]<MAX_NUM[t]&&(this.ctx.beginPath(),this.ctx.arc(e,i,s,0,2*Math.PI*(1-this.accumulations[t]/CDS[t]),!1),this.ctx.fillStyle="#0a5079",this.ctx.fill())}this.ctx.font="px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(parseInt(this.readyed_num[0]),this.position[0]*t+s,i+s)}}class FireBall extends MovableGameObject{constructor(t,s,i,e,a,h,r,n,o=1,l,d,c,_){super(t.x,t.y,h,r,a,n),this.owner=t,this.playground=t.playground,this.idx=s,this.ctx=this.playground.game_map.ctx,this.radius=i,this.color=e,this.damage=o,this.offset_x=l,this.offset_y=d,this.offset_owner_x=c,this.offset_owner_y=_,this.eps=.01,this.transform_speed=1,this.transformed_radius=i}start(){}check_players(){for(let t=0;t<this.playground.players.length;t++){let s=this.playground.players[t];if(s.uuid!==this.owner.uuid){let i,e;this.owner.charactor==ME&&s.charactor!=ME?(i=this.x-s.x+this.offset_x,e=this.y-s.y+this.offset_y):this.owner.charactor!=ME&&(s.charactor!=ME?(i=this.x-s.x,e=this.y-s.y):s.charactor==ME&&(i=this.x-this.playground.offset_x-s.x,e=this.y-this.playground.offset_y-s.y));let a=Math.sqrt(i*i+e*e);if(a<this.radius+s.radius){this.damage_work_player(s,t),this.destroy();break}if(s.shield&&a<this.radius+s.shield_size){s.shield=!1,this.destroy();break}}}}check_all_fire_balls(){let t=this.playground.players.length;for(let s=0;s<t;s++){let t=this.playground.players[s],i=t.fire_balls.length,e=0;e=this.owner.charactor==ME?t.charactor==ME?1:2:t.charactor!=ME?1:3;for(let s=0;i>1&&s<i;s++){if(this.owner.uuid==t.uuid&&this.idx==s)continue;let i,a,h=t.fire_balls[s];switch(e){case 1:i=this.x-h.x,a=this.y-h.y;break;case 2:i=this.x-h.x+this.offset_x,a=this.y-h.y+this.offset_y;break;case 3:i=this.x-this.playground.offset_x-h.x,a=this.y-this.playground.offset_y-h.y}if(Math.sqrt(i*i+a*a)<this.radius+h.radius){this.owner.uuid!=t.uuid?this.hit_others_fire_ball(h):this.hit_my_fire_ball(h);break}}}}calculate_dist(t){let s,i;return this.owner.charactor==ME?(s=this.x-t.x+this.offset_x,i=this.y-t.y+this.offset_y):(s=this.x-t.x,i=this.y-t.y),Math.sqrt(s*s+i*i)<this.radius+t.radius}check_blood_packs(){let t=this.playground.game_map.rewards.length;for(let s=0;s<t;s++){let t=this.playground.game_map.rewards[s];if(this.calculate_dist(t)){t.owner=this.owner,this.destroy();break}}}check_booms(){let t=this.playground.game_map.booms.length;for(let s=0;s<t;s++){let t=this.playground.game_map.booms[s];if(this.calculate_dist(t)){t.awake=!0,this.destroy();break}}}damage_check(){this.check_players(),this.check_all_fire_balls(),this.check_blood_packs(),this.check_booms()}hit_others_work(t,s){t.damage-=s.damage,t.transform_speed=FIRE_BALL_SMALLEN_SPEED,t.transformed_radius-=s.radius,t.speed*=.8,Particle.make_particle(s,this.playground.scale,s.damage,s.owner.charactor),s.destroy()}hit_mine_work(t,s){t.damage+=s.damage,t.transform_speed=FIRE_BALL_LARGEN_SPEED,t.transformed_radius+=1.2*s.radius,t.speed*=1.5,t.moveLength*=1.3,s.destroy()}hit_others_fire_ball(t){this.radius<t.radius?this.hit_others_work(t,this):this.radius>t.radius?this.hit_others_work(this,t):(Particle.make_particle(this,this.playground.scale,this.damage,this.owner.charactor),Particle.make_particle(t,this.playground.scale,t.damage,t.owner.charactor),this.destroy(),t.destroy())}hit_my_fire_ball(t){this.radius<=t.radius?this.hit_mine_work(t,this):this.hit_mine_work(this,t)}damage_work_player(t,s){t.be_hit(this.damage,this.vx,this.vy),this.playground.game_mode==MULTI_MODE&&this.playground.mps.send_hit_player(t.uuid,this.damage,this.vx,this.vy),t.HP<=0&&(this.owner.charactor==ME&&(this.owner.cd.readyed_fire_ball_num+=2),t.destroy(),this.playground.players.splice(s,1))}check_state(){return!(this.moveLength<this.eps||this.speed<this.eps)}update_radius(){1!=this.transform_speed&&(this.radius*=this.transform_speed,Math.abs(this.radius-this.transformed_radius)<this.eps&&(this.transform_speed=1))}update(){this.check_state()?(this.update_position(),this.update_radius(),this.damage_check(),this.render()):this.destroy()}finalize(){let t=this.owner.fire_balls.length;for(let s=this.idx+1;s<t;s++)this.owner.fire_balls[s].idx--;this.owner.fire_balls.splice(this.idx,1)}render(){let t,s,i=this.playground.scale,e=this.radius*i;this.owner.charactor==ME?(t=(this.x-this.offset_owner_x)*i,s=(this.y-this.offset_owner_y)*i):(t=(this.x-this.playground.offset_x)*i,s=(this.y-this.playground.offset_y)*i),(this.owner.charactor==ME||this.playground.check_in_camare(t,s,e))&&(this.ctx.beginPath(),this.ctx.arc(t,s,e,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}}class MultiPlayerSocket{constructor(t){this.playground=t,this.uuid=this.playground.players[0].uuid,this.ws=new WebSocket("wss://app1179.acapp.acwing.com.cn/wss/multiplayer/"),this.start()}start(){this.receive()}receive(){let t=this;this.ws.onmessage=function(s){let i=JSON.parse(s.data),e=i.uuid;if(e===t.uuid)return!1;switch(i.event){case"create_player":t.receive_create_player(e,i.username,i.photo);break;case"move_to":t.receive_move_to(e,i.x,i.y,i.vx,i.vy,i.moveLength);break;case"shoot_fire_ball":t.receive_shoot_fire_ball(e,i.mouse_x,i.mouse_y,i.offset_x,i.offset_y);break;case"move_stop":t.receive_move_stop(e);break;case"burst":t.receive_burst(e,i.mouse_x,i.mouse_y);break;case"shield":t.receive_shield(e);break;case"hit_player":t.receive_hit_player(e,damage,vx,vy)}}}send_create_player(t,s){this.ws.send(JSON.stringify({event:"create_player",uuid:this.uuid,username:t,photo:s}))}receive_create_player(t,s,i){let e=new Player(this.playground,HP,this.playground.camare_width/2/this.playground.scale,.5,PLAYER_RADIUS,"green",PLAYER_SPEED,ENERMY,s,i);e.uuid=t,this.playground.players.push(e)}send_move_to(t,s,i,e,a,h){this.ws.send(JSON.stringify({event:"move_to",uuid:t,x:s,y:i,vx:e,vy:a,moveLength:h}))}get_player_by_uuid(t){for(let s=0;s<this.playground.players.length;s++){let i=this.playground.players[s];if(i.uuid===t)return i}return null}receive_move_to(t,s,i,e,a,h){let r=this.get_player_by_uuid(t);r&&(r.x=s,r.y=i,r.vx=e,r.vy=a,r.moveLength=h)}send_shoot_fire_ball(t,s,i,e,a){this.ws.send(JSON.stringify({event:"shoot_fire_ball",uuid:t,mouse_x:s,mouse_y:i,offset_x:e,offset_y:a}))}receive_shoot_fire_ball(t,s,i,e,a){let h=this.get_player_by_uuid(t);h&&(h.cur_skill=1,h.unleash_skills(s,i,e,a))}send_burst(t,s,i){this.ws.send(JSON.stringify({event:"burst",uuid:t,mouse_x:s,mouse_y:i}))}receive_burst(t,s,i){let e=this.get_player_by_uuid(t);e&&(e.cur_skill=3,e.unleash_skills(s,i))}send_move_stop(t){this.ws.send(JSON.stringify({event:"move_stop",uuid:t}))}receive_move_stop(t){let s=this.get_player_by_uuid(t);s&&(s.moveLength=0)}send_shield(t){this.ws.send(JSON.stringify({event:"shield",uuid:t}))}receive_shield(t){let s=this.get_player_by_uuid(t);s&&(s.shield=!0)}send_hit_player(t,s,i,e){this.ws.send(JSON.stringify({event:"hit_player",uuid:t,damage:s,vx:i,vy:e}))}receive_hit_player(t,s,i,e){let a=this.get_player_by_uuid(t);a&&a.be_hit(s,i,e)}}const HP=20,PLAYER_SPEED=.16,PLAYER_RADIUS=.045,FIRE_BALL_SPEED=2*PLAYER_SPEED,PARTICLE_SPEED=15*PLAYER_SPEED,ROBOT_SPEED=.12,BLOOD_PACKS_SPEED=1,ME=1,ROBOT=2,ENERMY=3,SINGLE_MODE=1,MULTI_MODE=2,FIRE_BALL_LARGEN_SPEED=1.04,FIRE_BALL_SMALLEN_SPEED=.985,GENERATE_REWARDS_MOVELENGTH=.2;class GamePlayground{constructor(t){this.root=t,this.$playground=$('<div class="game_playground"></div>'),this.root.$game.append(this.$playground),this.hide(),this.start()}update_offset(t,s,i){Math.abs((this.offset_x+t+i)*this.scale)<2*this.camare_width&&Math.abs((this.offset_y+s+i)*this.scale)<2*this.camare_height&&(this.offset_x+=t,this.offset_y+=s)}check_in_camare(t,s,i){let e=s+i,a=t-i,h=s-i;return t+i>this.camare_x1&&e>this.camare_y1&&a<this.camare_x2&&h<this.camare_y2}resize(){this.width=5*this.$playground.width(),this.height=5*this.$playground.height(),this.camare_width=this.$playground.width(),this.camare_height=this.$playground.height(),this.camare_x1=0,this.camare_y1=0,this.camare_x2=this.$playground.width(),this.camare_y2=this.$playground.height();let t=Math.min(this.camare_width/16,this.camare_height/9);this.camare_width=16*t,this.camare_height=9*t,this.scale=this.camare_height,this.game_map&&this.game_map.resize()}start(){let t=this;$(window).resize((function(){t.resize()}))}show(t=1,s,i="big_map"){if(this.difficulty=t,this.game_mode=s,this.map_mode=i,this.offset_x=0,this.offset_y=0,this.difficulty,this.resize(),this.game_map=new GameMap(this),this.notice_board=new NoticeBoard(this,.15,.08),this.players=[],s==SINGLE_MODE)for(let t=0;t<40;t++){let t=Funcions.make_color();this.players.push(new Player(this,HP,this.width*Math.random()/this.scale,Math.random(),PLAYER_RADIUS,t,.12,ROBOT,"sharco"))}if(this.players.push(new Player(this,HP,this.camare_width/2/this.scale,.5,PLAYER_RADIUS,"green",PLAYER_SPEED,ME,this.root.settings.username,this.root.settings.photo)),s==MULTI_MODE){this.mps=new MultiPlayerSocket(this);let t=this;this.mps.ws.onopen=function(){t.mps.send_create_player(t.root.settings.username,t.root.settings.photo)}}this.$playground.show()}hide(){this.$playground.hide()}}export class Game{constructor(t,s){this.id=t,this.AcWingOS=s,this.$game=$("#"+t),this.settings=new Settings(this),this.menu=new GameMenu(this),this.playground=new GamePlayground(this),this.start()}start(){}}
